# 基于 XGBoost 的腾讯控股择时增强策略

## 1. 综述

本项目旨在探索机器学习算法在港股量化交易中的应用潜力，特别是针对腾讯控股（00700.HK）这一标的资产。我们构建了一个基于 **XGBoost (Extreme Gradient Boosting)** 算法的择时交易策略，旨在通过挖掘历史数据中的非线性模式来实现超额收益（Alpha）。

项目严格遵循实训要求：

* **训练数据**：选取 **2018年至2023年** 的日线数据作为训练集，用于构建和优化机器学习模型。
* **回测区间**：选取 **2024年1月1日至2025年4月24日** 作为样本外测试集（Test Set），模拟真实的投资环境。
* **资金设定**：初始资金 **100,000 HKD**。

我们利用 `Backtrader` 回测框架，结合高度拟真的港股交易成本模型（含印花税、佣金、平台费等），对策略进行了严谨的历史回测。结果显示，该策略在风险控制（最大回撤）和收益获取（年化收益）方面均显著优于传统的“买入持有”策略，实现了指数增强的目标。

## 2. 数学建模

本项目的回测系统基于 `Backtrader` 框架构建，为了确保回测结果具有现实指导意义，我们在数学建模层面进行了严格的约束，力求还原真实的港股交易环境。

### 2.1 资金管理与仓位控制

* **初始资金**：设定为 **100,000 HKD**。
* **全仓交易模式**：考虑到资金量较小，为了最大化资金利用率，所有策略均采用**全仓买卖**（Full Position）模式。即当发出买入信号时，尝试使用 99% 的可用资金买入（预留 1% 用于支付手续费）；发出卖出信号时，清空所有持仓。

### 2.2 交易成本模型

为了避免“回测赚钱，实盘亏钱”的情况，我们根据富途证券的[港股收费规则](<https://www.futuhk.com/hans/support/topic2_335>)重写了 Backtrader 的佣金模型 (`HKCommission`)，涵盖了以下费用：

1. **印花税 (Stamp Duty)**：成交金额的 **0.1%**（双边收取）。
    * 不足 1 HKD 按 1 HKD 收取，且向上取整。这是港股交易中最大的成本来源。
2. **交易佣金 (Commission)**：成交金额的 **0.03%**。
    * 最低收费 **3 HKD**。
3. **平台使用费 (Platform Fee)**：固定 **15 HKD/笔**。
4. **监管征费**：
    * 交易费 (Trading Fee): 0.00565%
    * 证监会征费 (SFC Levy): 0.0027%
    * 财汇局征费 (FRC Levy): 0.00015%
    * 结算费 (Settlement Fee): 0.002% (最低 2 HKD, 最高 100 HKD)

这种精细的费率模型能有效过滤掉那些因频繁交易而被手续费吞噬利润的“伪高频策略”。

### 2.3 市场微观结构与交易规则

* **手数限制 (Lot Size)**：严格遵守港股“一手 100 股”的交易规则。
  * 我们自定义了 `HKStockBroker`，在下单时强制检查交易数量。如果计算出的买入数量为 150 股，系统会自动向下取整为 100 股，余下资金保留为现金。这反映了资金闲置（Cash Drag）带来的损耗。
* **成交机制**：采用“次日开盘价（Open）”成交模式。
  * 策略在 T 日收盘后计算信号，指令在 T+1 日开盘瞬间执行。这避免了使用未来数据（Future Data）的作弊可能。

### 2.4 关于滑点 (Slippage) 的合理化假设

在本模型中，我们选择**忽略滑点**，理由如下：

1. **流动性充裕**：回测标的为**腾讯控股 (00700.HK)**，其日均成交额通常在 50亿-100亿港币级别。
2. **资金体量微小**：本策略资金仅为 10 万港币，买入指令会瞬间被卖一档（Ask 1）消化，产生的冲击成本（Impact Cost）几乎为零。
3. **价差覆盖**：腾讯的买卖价差（Spread）通常约为 0.05%，而我们计算的印花税高达 0.1%。在保守的费率模型下，忽略微小的价差滑点不会改变策略有效性的结论。

综上所述，本项目的数学建模在成本端极其严苛，在执行端符合交易所规则，是一个高度贴近现实的量化回测环境。

## 3. 算法架构与交易策略

### 3.1 数据预处理与特征工程 (Data Preprocessing & Feature Engineering)

为了构建高效的机器学习模型，我们对原始数据进行了精细的预处理和特征提取。

1. **数据清洗**:
    * 加载原始日线数据，处理缺失值，并确保时间序列的连续性。
    * 统一字段命名为 `open`, `high`, `low`, `close`, `volume`。

2. **特征挖掘 (Feature Mining)**:
    我们选取了以下几类对股价预测有效的因子：
    * **趋势因子**:
        * **移动平均线 (MA)**: 计算 5日、10日、20日均线，捕捉不同周期的趋势。
        * **MACD**: 计算 DIF, DEA, MACD柱，用于识别趋势的强弱和转折点。
    * **动量因子**:
        * **RSI (相对强弱指数)**: 周期为 14，用于判断超买超卖状态。
    * **波动率因子**:
        * **布林带 (Bollinger Bands)**: 计算上轨和下轨，衡量价格的相对高低和波动范围。
        * **ATR (平均真实波幅)**: 周期为 14，直接衡量市场波动性。
    * **时间序列特征 (Lag Features)**:
        * 为了捕捉市场的记忆性，我们对关键变量（收盘价、成交量、RSI、MACD柱）进行了 **1至5阶滞后处理**。这使得模型能够利用过去5天的市场状态来预测未来。
    * **收益率特征**:
        * 计算当日及过去5日的对数收益率，作为反映市场近期涨跌幅度的直接指标。

### 3.2 机器学习模型构建 (Machine Learning Model)

1. **算法选择：XGBoost**:
    本项目选用 **XGBoost (Extreme Gradient Boosting)** 作为核心预测算法。
    * **优点分析**:
        * **非线性建模能力**: 股市是非线性的复杂系统，XGBoost 基于树模型，能有效捕捉变量间的高阶交互关系。
        * **抗过拟合**: 内置正则化项（L1/L2），能有效防止模型在噪声较大的金融数据上过拟合。
        * **特征重要性**: 能够自动评估各个因子的重要性，具有良好的可解释性。
        * **鲁棒性**: 对异常值和缺失值不敏感，适合处理真实市场数据。

   **模型训练与集成**:
    * **训练集**: 2018年1月1日 至 2023年12月31日。
    * **测试集**: 2024年1月1日 至 2025年4月24日。
    * **集成策略 (Ensemble)**: 为了进一步提高预测的稳定性，我们采用了 Bagging 的思想，训练了 **50 个** 独立的 XGBoost 模型（随机种子 42-91）。
    * **参数设置**:
        * `n_estimators`: 90 (树的数量)
        * `learning_rate`: 0.02 (低学习率以提高泛化能力)
        * `max_depth`: 5 (控制树的深度，防止过拟合)
        * `subsample`: 0.85 (随机采样样本)
        * `colsample_bytree`: 0.80 (随机采样特征)
    * **预测目标**: 预测**次日收盘价是否上涨**（二分类问题）。最终输出为 50 个模型预测概率的平均值。

### 3.3 交易策略逻辑 (Trading Strategy Logic)

基于模型输出的“次日上涨概率” ($P_{up}$) 进行决策，采用双阈值机制来过滤震荡信号。

* **信号生成**:
  * **买入信号**: 当 $P_{up} > 0.52$ 时，发出**全仓买入**指令。
  * **卖出信号**: 当 $P_{up} < 0.40$ 时，发出**清仓卖出**指令。
  * **持仓保持**: 当 $0.40 \le P_{up} \le 0.52$ 时，维持当前仓位不变。
* **执行逻辑**:
  * 信号在 T 日收盘后生成。
  * 交易指令在 T+1 日开盘时以**开盘价**执行。
  * 遵守港股**一手 (100股)** 的交易限制，不足一手的部分保留为现金。

## 4. 结果与分析

### 4.1 回测概况

* **回测区间**: 2024-01-01 至 2025-04-24
* **标的资产**: 腾讯控股 (00700.HK)
* **基准策略**: 买入持有 (Buy and Hold)
* **对比策略**: 均线交叉 (MA Cross), MACD, RSI 均值回归, 布林带突破
* **实验策略**: XGBoost 增强策略

### 4.2 核心指标对比

为了全面评估 XGBoost 策略的有效性，我们将其与多种经典技术指标策略进行了横向对比。下表展示了各策略的详细性能指标：

| 策略 (Strategy) | 总回报 (Total Return) | 年化收益 (CAGR) | 最大回撤 (Max Drawdown) | 夏普比率 (Sharpe) | 交易次数 | 胜率 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **XGBoost 增强** | **73.93%** | **54.42%** | **7.99%** | 2.55 | 9 | 77.78% |
| 买入持有 (Buy & Hold) | 60.64% | 45.08% | 23.22% | 1.59 | 1 | - |
| 均线交叉 (MA Cross) | 31.32% | 23.85% | 24.26% | 5.93 | 9 | 33.33% |
| MACD 策略 | 31.95% | 24.31% | 15.40% | 1.40 | 9 | 44.44% |
| RSI 均值回归 | 19.76% | 15.21% | 2.16% | 0.60 | 1 | 100.00% |
| 布林带突破 | -1.37% | -1.08% | 29.42% | -0.64 | 4 | 75.00% |

**分析**:

* **XGBoost 策略**在总回报和年化收益上均位居第一，且最大回撤控制在极低水平 (7.99%)，综合表现最优。
* **均线交叉**和**MACD**策略虽然也能盈利，但收益率远低于买入持有策略，且回撤较大，说明单纯的技术指标在当前市场环境下效果有限。
* **RSI 均值回归**策略虽然回撤极小，但交易机会太少（仅1次），收益率较低。
* **布林带突破**策略表现最差，出现了负收益，表明该策略不适合当前的震荡上行行情。

### 4.3 策略与模型效果评估 (Evaluation)

1. **投资结果与实际数据对比**:
    * **实际市场表现**: 腾讯控股在 2024-2025 年期间经历了较大的波动，虽然最终实现了约 60% 的涨幅，但中间经历了超过 23% 的大幅回撤，持股体验极其颠簸。
    * **策略表现**: 我们的策略资金曲线（见附图）呈现出阶梯式上涨的形态。在市场下跌或震荡期间（如2024年中期），策略能够空仓观望，成功规避了大部分下行风险；在市场确立上涨趋势时，策略能够果断介入。

2. **模型效果评估**:
    * **预测准确性**: 策略在扣除费率后仍保持 **77.78%** 的高胜率。值得注意的是，在未扣除手续费时胜率为 **88.89%**，胜率的下降是因为有一笔微利交易的毛利润不足以覆盖港股较高的交易成本（如 0.1% 的印花税），从而在净值层面被判定为亏损。这恰恰体现了本回测系统的严谨性——它有效识别并剔除了那些无法覆盖交易成本的“伪机会”。
    * **泛化能力**: 在完全样本外的测试数据上取得如此优异的成绩，说明模型没有过拟合，且通过集成学习（Ensemble）有效提升了鲁棒性，避免了因为种子不同而导致结果差别较大的问题。

3. **风险控制评估**:
    * **最大回撤优化**: 将最大回撤从 23.22% 降低至 7.99%，这是量化交易最核心的价值所在——在保住本金的前提下追求收益。
    * **夏普比率**: 2.55 的夏普比率远超市场平均水平（通常 >1 即为优秀），说明策略获取的每一分收益背后承担的风险极低。

4. **附加功能亮点**:
    * **真实费率模型**: 考虑了印花税（0.1%）、最低佣金、平台费等细节，确保回测结果真实可信。
    * **整手交易限制**: 严格遵守港股一手100股规则，模拟了资金闲置带来的真实损耗。

## 5. 总结

本项目构建了一个基于 XGBoost 的港股量化交易系统。通过严格的数学建模（全仓交易、真实费率、整手限制）和稳健的机器学习算法（集成学习、滞后特征），策略在样本外测试中表现优异。

结果表明，该策略不仅能够跑赢市场基准，更重要的是能够显著降低市场波动带来的风险（最大回撤从 23% 降至 8%）。这验证了“机器学习模型 + 严格资金管理”在港股投资中的实战价值。

## 6. 环境配置

本项目基于 Python 3.12.12 开发。为了复现本项目的回测结果，请确保安装以下依赖包。

### 6.1 核心依赖库

* **Backtrader**: 用于构建回测系统和交易逻辑。
* **XGBoost**: 核心机器学习算法，用于股价涨跌预测。
* **Pandas**: 用于数据处理和特征工程。
* **Scikit-learn**: 用于模型评估和辅助工具。
* **Matplotlib**: 用于绘制收益曲线和分析图表。

### 6.2 安装说明

所有依赖项已列在项目根目录的 `requirements.txt` 文件中。您可以使用以下命令一键安装：

```bash
pip install -r requirements.txt
```
