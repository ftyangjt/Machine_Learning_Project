# 报告 中文版

## 1. 综述

本项目旨在探索机器学习算法在港股量化交易中的应用潜力。我们以腾讯控股（00700.HK）为标的资产，构建了一个基于 XGBoost 算法的择时交易策略。项目利用 Backtrader 回测框架，结合真实的市场交易成本模型（印花税、佣金等），对策略在 2024 年至 2025 年期间的表现进行了严谨的历史回测。结果显示，该策略在风险控制和收益获取方面均显著优于传统的“买入持有”策略。

## 2. 数学建模

本项目的回测系统基于 `Backtrader` 框架构建，为了确保回测结果具有现实指导意义，我们在数学建模层面进行了严格的约束，力求还原真实的港股交易环境。

### 2.1 资金管理与仓位控制
*   **初始资金**：设定为 **100,000 HKD**。
*   **全仓交易模式**：考虑到资金量较小，为了最大化资金利用率，所有策略均采用**全仓买卖**（Full Position）模式。即当发出买入信号时，尝试使用 99% 的可用资金买入（预留 1% 用于支付手续费）；发出卖出信号时，清空所有持仓。
*   **现实考量**：对于小资金账户，分仓交易会导致单笔交易金额过小，从而使得固定费率（如平台费）占比过高，大幅拖累收益。全仓交易虽然波动较大，但在小资金阶段是更优的选择。

### 2.2 极度拟真的交易成本模型
港股的交易成本结构远比 A 股或美股复杂。为了避免“回测赚钱，实盘亏钱”的情况，我们重写了 Backtrader 的佣金模型 (`HKCommission`)，精确涵盖了以下所有费用：

1.  **印花税 (Stamp Duty)**：成交金额的 **0.1%**（双边收取）。
    *   *细节*：不足 1 HKD 按 1 HKD 收取，且向上取整。这是港股交易中最大的成本来源。
2.  **交易佣金 (Commission)**：成交金额的 **0.03%**。
    *   *细节*：最低收费 **3 HKD**。
3.  **平台使用费 (Platform Fee)**：固定 **15 HKD/笔**。
    *   *影响*：对于 10 万资金的全仓交易（约 400 股腾讯），这笔费用占比不大；但如果资金更小，这笔固定费用将显著提高盈亏平衡点。
4.  **监管征费**：
    *   交易费 (Trading Fee): 0.00565%
    *   证监会征费 (SFC Levy): 0.0027%
    *   财汇局征费 (FRC Levy): 0.00015%
    *   结算费 (Settlement Fee): 0.002% (最低 2 HKD, 最高 100 HKD)

**建模意义**：这种精细的费率模型能有效过滤掉那些因频繁交易而被手续费吞噬利润的“伪高频策略”。

### 2.3 市场微观结构与交易规则
*   **手数限制 (Lot Size)**：严格遵守港股“一手 100 股”的交易规则。
    *   我们自定义了 `HKStockBroker`，在下单时强制检查交易数量。如果计算出的买入数量为 150 股，系统会自动向下取整为 100 股，余下资金保留为现金。这真实反映了资金闲置（Cash Drag）带来的损耗。
*   **成交机制**：采用“次日开盘价（Open）”成交模式。
    *   策略在 T 日收盘后计算信号，指令在 T+1 日开盘瞬间执行。这完全避免了使用未来数据（Future Data）的作弊可能。

### 2.4 关于滑点 (Slippage) 的合理化假设
在本模型中，我们选择**忽略滑点**，理由如下：
1.  **流动性充裕**：回测标的为**腾讯控股 (00700.HK)**，其日均成交额通常在 50亿-100亿港币级别。
2.  **资金体量微小**：本策略资金仅为 10 万港币，相对于腾讯的盘口深度，属于“沧海一粟”。买入指令会瞬间被卖一档（Ask 1）消化，产生的冲击成本（Impact Cost）几乎为零。
3.  **价差覆盖**：腾讯的买卖价差（Spread）通常约为 0.05%，而我们计算的印花税高达 0.1%。在保守的费率模型下，忽略微小的价差滑点不会改变策略有效性的结论。

综上所述，本项目的数学建模在成本端极其严苛，在执行端符合交易所规则，是一个高度贴近现实的量化回测环境。

## 3. 算法架构与交易策略

### 3.1 算法架构 (Algorithm Architecture)
本策略的核心在于利用机器学习模型从多维市场数据中提取非线性模式，以预测股价的短期走势。

*   **数据源 (Data Feed)**:
    *   使用自定义的 `MLData` 类，除了基础的 OHLCV (Open, High, Low, Close, Volume) 数据外，还集成了多种技术指标作为特征输入。
*   **特征工程 (Feature Engineering)**:
    *   **基础特征**: 开盘价、最高价、最低价、收盘价、成交量。
    *   **技术指标**: 移动平均线 (MA5, MA10, MA20)、相对强弱指数 (RSI14)、MACD (DIF, DEA, BAR)、布林带 (Upper, Lower)、平均真实波幅 (ATR14)。
    *   **滞后特征 (Lag Features)**: 为了捕捉时间序列的依赖性，对 Close, Volume, RSI, MACD_BAR 进行了 5 阶滞后处理（Lag 1-5）。
    *   **收益率特征**: 包含当日及过去 5 日的收益率。
*   **模型选择 (Model Selection)**:
    *   采用 **XGBoost (Extreme Gradient Boosting)** 分类器。
    *   **集成学习 (Ensemble Learning)**: 训练了 **50 个** 独立的 XGBoost 模型，每个模型使用不同的随机种子。最终预测结果为所有模型预测概率的平均值。这种方法有效降低了单一模型的方差，提高了策略在未知市场环境下的泛化能力。
    *   **训练机制**: 使用 **2024年1月1日之前** 的历史数据进行训练，确保回测期间（2024-01-01 至 2025-04-24）完全是**样本外 (Out-of-Sample)** 测试，避免了过拟合带来的虚假繁荣。

### 3.2 交易策略逻辑 (Trading Strategy Logic)
策略根据模型输出的“次日上涨概率” ($P_{up}$) 进行决策，采用双阈值机制来过滤震荡信号。

*   **信号生成**:
    *   **买入信号**: 当 $P_{up} > 0.536$ 时，发出**全仓买入**指令。
    *   **卖出信号**: 当 $P_{up} < 0.392$ 时，发出**清仓卖出**指令。
    *   **持仓保持**: 当 $0.392 \le P_{up} \le 0.536$ 时，维持当前仓位不变。
*   **执行逻辑**:
    *   信号在 T 日收盘后生成。
    *   交易指令在 T+1 日开盘时以**开盘价**执行。
    *   严格遵守港股**一手 (100股)** 的交易限制，不足一手的部分保留为现金。

## 4. 结果与分析

### 4.1 回测概况
*   **回测区间**: 2024-01-01 至 2025-04-24
*   **标的资产**: 腾讯控股 (00700.HK)
*   **基准策略**: 买入持有 (Buy and Hold)
*   **实验策略**: XGBoost 增强策略

### 4.2 核心指标对比
下表展示了 XGBoost 策略与基准策略的详细性能对比：

| 指标 (Metrics) | 买入持有 (Buy & Hold) | XGBoost 策略 | 提升幅度 |
| :--- | :--- | :--- | :--- |
| **总回报 (Total Return)** | 60.64% | **76.47%** | +15.83% |
| **年化收益率 (CAGR)** | 45.08% | **56.19%** | +11.11% |
| **最大回撤 (Max Drawdown)** | 23.22% | **7.99%** | **大幅优化** |
| **夏普比率 (Sharpe Ratio)** | 1.59 | **3.45** | +116% |
| **交易次数 (Trade Count)** | 1 | 8 | - |
| **胜率 (Win Rate)** | - | **75.00%** | - |

### 4.3 深度分析
1.  **收益能力显著增强**:
    XGBoost 策略在回测期内实现了 **76.47%** 的总回报，显著跑赢买入持有策略。年化收益率高达 **56.19%**，证明了机器学习模型在捕捉市场波段方面的有效性。

2.  **风险控制极其出色**:
    这是本策略最大的亮点。在基准策略经历 **23.22%** 的大幅回撤时，XGBoost 策略通过及时的止盈和止损，将最大回撤控制在仅 **7.99%**。这意味着策略成功规避了市场的主要下跌波段，资金曲线更加平滑稳健。**3.45** 的高夏普比率也印证了这一点，表明策略承担单位风险所获得的超额收益极高。

3.  **交易成本与频率**:
    在近 16 个月的时间里，策略仅进行了 **8 次** 交易（4买4卖），属于典型的**波段交易 (Swing Trading)**。
    *   **成本影响**: 尽管交易次数不多，但由于采用了真实的港股费率模型（含印花税等），总计支付了 **3,151.16 HKD** 的手续费（约占初始资金的 3%）。
    *   **启示**: 这再次证明了在港股市场中，控制交易频率对于小资金账户的重要性。如果采用高频策略，这笔费用可能会吞噬大部分利润。目前的低频策略在覆盖成本后依然保持了高额净收益。

## 5. 总结
本项目构建了一个基于 XGBoost 的港股量化交易系统。通过严格的数学建模（全仓交易、真实费率、整手限制）和稳健的机器学习算法（集成学习、滞后特征），策略在样本外测试中表现优异。

结果表明，该策略不仅能够跑赢市场基准，更重要的是能够显著降低市场波动带来的风险（最大回撤从 23% 降至 8%）。这验证了“机器学习模型 + 严格资金管理”在港股投资中的实战价值。

## 6. 环境配置

本项目基于 Python 3.12.5 开发。为了复现本项目的回测结果，请确保安装以下依赖包。

### 6.1 核心依赖库
*   **Backtrader**: 用于构建回测系统和交易逻辑。
*   **XGBoost**: 核心机器学习算法，用于股价涨跌预测。
*   **Pandas**: 用于数据处理和特征工程。
*   **Scikit-learn**: 用于模型评估和辅助工具。
*   **Matplotlib**: 用于绘制收益曲线和分析图表。

### 6.2 安装说明
所有依赖项已列在项目根目录的 `requirements.txt` 文件中。您可以使用以下命令一键安装：

```bash
pip install -r requirements.txt
```
