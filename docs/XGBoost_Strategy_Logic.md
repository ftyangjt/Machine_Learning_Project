# XGBoost 机器学习策略逻辑详解

本文档详细描述了本项目中使用的 XGBoost 择时策略的内部逻辑、特征工程及交易规则。

## 1. 策略核心思想

该策略属于**监督学习（Supervised Learning）**下的**二分类（Binary Classification）**策略。
核心思想是利用过去的市场数据（价格、成交量、技术指标）来预测**下一个交易日**的收盘价相对于今日收盘价是**上涨**还是**下跌**。

- **预测目标**: $P(Close_{t+1} > Close_t)$
- **模型架构**: 集成学习（Ensemble Learning），由 50 个独立的 XGBoost 分类器组成。

## 2. 特征工程 (Feature Engineering)

模型输入不仅包含当前时刻的状态，还包含过去一段时间的时间序列特征，以捕捉市场趋势。

### 2.1 基础特征 (Base Features)
每一天的数据包含以下 15 个基础指标：
1.  **量价数据**: Open, High, Low, Close, Volume
2.  **均线系统**: MA5, MA10, MA20
3.  **动量指标**: RSI (14周期)
4.  **趋势指标**: MACD (DIF, DEA, MACD Bar)
5.  **波动率/通道**: Bollinger Bands (Upper, Lower), ATR (14周期)

### 2.2 滞后特征 (Lagged Features)
为了让模型“看到”过去的历史走势，我们对关键指标进行了滞后处理（Lagging）。
- **滞后对象**: Close, Volume, RSI14, MACD Bar
- **滞后窗口**: 过去 5 天 (Lag 1 to Lag 5)
- **目的**: 捕捉短期内的价格动量和指标变化率。

### 2.3 收益率特征 (Return Features)
- **每日收益率**: $Return_t = \frac{Close_t}{Close_{t-1}} - 1$
- **滞后收益率**: 过去 5 天的收益率数据。

---

## 3. 模型训练架构 (Training Architecture)

### 3.1 数据集划分
- **训练集**: 2024年1月1日之前的所有历史数据。
- **测试/回测集**: 2024年1月1日之后的数据。
- **防止未来函数**: 训练时严格只使用截止到 $t$ 日的数据来预测 $t+1$ 日的目标，绝不使用未来数据。

### 3.2 标签定义 (Labeling)
- **Target = 1 (上涨)**: 如果 $Close_{t+1} > Close_t$
- **Target = 0 (下跌/平盘)**: 如果 $Close_{t+1} \le Close_t$

### 3.3 集成模型 (Ensemble)
为了降低单一模型的方差，提高预测的稳定性，策略采用了 **Bagging** 的思想：
- **模型数量**: 50 个 XGBoostClassifier。
- **随机性**: 每个模型使用不同的随机种子 (`random_state = 42 + i`)。
- **参数配置**:
    - `n_estimators`: 100 (树的数量)
    - `learning_rate`: 0.02 (学习率，较低的学习率有助于防止过拟合)
    - `max_depth`: 5 (树深)
    - `subsample`: 0.8 (样本采样率)
    - `colsample_bytree`: 0.8 (特征采样率)

---

## 4. 交易信号与执行 (Signals & Execution)

在回测（或实盘）的每一天收盘后，策略执行以下步骤：

### 4.1 信号生成
1.  **特征构建**: 实时计算当天的所有特征（含滞后特征）。
2.  **模型预测**: 将特征输入到 50 个训练好的模型中，获取每个模型对“上涨”类别的预测概率。
3.  **概率平均**: 计算 50 个模型预测概率的平均值 `avg_prob`。

### 4.2 交易规则
策略采用双阈值机制来过滤震荡信号：

- **买入/建仓条件**:
    - 当前**无持仓**。
    - 且 `avg_prob > 0.55` (模型认为上涨概率超过 55%)。
    - **动作**: 下一交易日开盘市价买入，使用 99% 的现金（预留 1% 用于手续费）。

- **卖出/平仓条件**:
    - 当前**持有仓位**。
    - 且 `avg_prob < 0.45` (模型认为上涨概率低于 45%，即下跌概率较高)。
    - **动作**: 下一交易日开盘市价卖出所有持仓。

- **持有/观望**:
    - 如果概率在 0.45 到 0.55 之间，保持当前状态不变（持仓者继续持仓，空仓者继续空仓）。

### 4.3 订单执行 (Backtrader 机制)
- **信号时间**: T 日收盘 (`next()` 方法执行时)。
- **执行时间**: T+1 日开盘 (`Open` 价格)。
- **滑点与费用**: 
    - 按照港股费率计算（佣金、印花税、平台费等）。
    - 实际成交价为 T+1 日 Open 价。

---

## 5. 策略优势与风险

### 优势
1.  **非线性能力**: XGBoost 能捕捉技术指标之间复杂的非线性关系。
2.  **抗噪性**: 50 个模型的集成投票机制比单一模型更稳健，不易受个别异常数据影响。
3.  **双阈值设计**: 0.55/0.45 的缓冲区设计减少了在概率模糊区间的频繁交易，降低了交易成本。

### 风险
1.  **过拟合**: 尽管使用了集成和正则化，机器学习模型仍可能过度拟合历史噪音。
2.  **市场风格切换**: 如果未来市场规律与 2024 年之前完全不同（Concept Drift），模型效果会下降。
3.  **隔夜风险**: 策略基于 T 日收盘决策，T+1 日开盘执行，无法规避隔夜的跳空低开风险。
